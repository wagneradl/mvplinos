// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                  Int                  @id @default(autoincrement())
  nome                String
  email               String               @unique
  senha               String
  papel_id            Int
  status              String               @default("ativo")
  created_at          DateTime             @default(now())
  updated_at          DateTime             @updatedAt
  deleted_at          DateTime?
  papel               Papel                @relation(fields: [papel_id], references: [id])
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]
}

model Papel {
  id              Int       @id @default(autoincrement())
  nome            String    @unique
  codigo          String    @unique  // Ex: 'ADMIN_SISTEMA', 'OPERADOR_PEDIDOS', 'CLIENTE_ADMIN'
  descricao       String
  tipo            String    @default("INTERNO")  // 'INTERNO' ou 'CLIENTE'
  nivel           Int       @default(0)  // Hierarquia: ADMIN_SISTEMA=100, GERENTE_COMERCIAL=80, etc.
  permissoes      String    // JSON com as permissões (ex: {"clientes": ["listar","ver","criar"], ...})
  ativo           Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  usuarios        Usuario[]
}

model PasswordResetToken {
  id         Int       @id @default(autoincrement())
  usuario_id Int
  token      String    @unique
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime  @default(now())
  usuario    Usuario   @relation(fields: [usuario_id], references: [id])
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  usuario_id Int
  token      String    @unique
  ip_address String?
  user_agent String?
  expires_at DateTime
  revoked_at DateTime?
  created_at DateTime  @default(now())
  usuario    Usuario   @relation(fields: [usuario_id], references: [id])
}

model Cliente {
  id            Int       @id @default(autoincrement())
  cnpj          String    @unique
  razao_social  String
  nome_fantasia String
  email         String
  telefone      String
  status        String    @default("ativo")
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  deleted_at    DateTime?
  pedidos       Pedido[]
}

model Produto {
  id             Int          @id @default(autoincrement())
  nome           String       @unique
  preco_unitario Float
  tipo_medida    String
  status         String       @default("ativo")
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt
  deleted_at     DateTime?
  itensPedido    ItemPedido[]
}

model Pedido {
  id          Int          @id @default(autoincrement())
  cliente_id  Int
  data_pedido DateTime     @default(now())
  valor_total Float
  status      String       @default("PENDENTE")
  pdf_path    String?
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  deleted_at  DateTime?
  pdf_url     String?      // URL do arquivo PDF no Supabase Storage
  observacoes String?      // Observações sobre o pedido (opcional)
  itensPedido ItemPedido[]
  cliente     Cliente      @relation(fields: [cliente_id], references: [id])
}

model ItemPedido {
  id             Int      @id @default(autoincrement())
  pedido_id      Int
  produto_id     Int
  quantidade     Float
  preco_unitario Float
  valor_total_item Float
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  pedido         Pedido   @relation(fields: [pedido_id], references: [id])
  produto        Produto  @relation(fields: [produto_id], references: [id])
}