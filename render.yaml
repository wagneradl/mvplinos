services:
  # Backend Service
  - type: web
    name: linos-backend
    env: node
    region: oregon
    plan: starter
    buildCommand: |
      yarn install --check-files
      node scripts/render-postinstall.js
      cd packages/backend
      yarn prisma generate
      yarn build
    startCommand: >
      cd packages/backend &&
      npx prisma migrate deploy &&
      npx prisma db seed &&
      NODE_ENV=production node dist/main.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        value: file:/var/data/linos-panificadora.db
      - key: PDF_STORAGE_PATH
        value: /var/data/pdfs
      - key: UPLOADS_PATH
        value: /var/data/uploads
      # Supabase configuração
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_API_KEY
        sync: false
      - key: SUPABASE_BUCKET
        value: pedidos-pdfs
      - key: PUPPETEER_SKIP_DOWNLOAD
        value: "true"
      - key: CORS_ORIGINS
        value: "https://linos-frontend-6wef.onrender.com,https://linos-frontend.onrender.com"
      - fromGroup: linos-secrets
    disk:
      name: data
      mountPath: /var/data
      sizeGB: 2
    buildFilter:
      paths:
        - packages/backend/**/*
    autoDeploy: true

  # Frontend Service
  - type: web
    name: linos-frontend
    env: node
    region: oregon
    plan: starter
    buildCommand: >
      yarn install --frozen-lockfile &&
      cd packages/frontend &&
      yarn build
    startCommand: cd packages/frontend && yarn start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        value: https://linos-backend.onrender.com
      - key: NEXT_SKIP_TYPECHECKING
        value: "1"
      - key: NEXT_TELEMETRY_DISABLED
        value: "1"
      - key: NODE_OPTIONS
        value: "--max_old_space_size=4096"
      - key: TSC_COMPILE_ON_ERROR
        value: "true"
    buildFilter:
      paths:
        - packages/frontend/**/*
    autoDeploy: true

envVarGroups:
  - name: linos-secrets
    envVars:
      - key: JWT_SECRET
        generateValue: true
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_API_KEY
        sync: false